---
title: "Data Discovery in R"
author: "Michael Clark <br> Center for Statistical Consultation and Research <br> University of Michigan"
date: "Fall, 2015"
output: 
  ioslides_presentation: 
    smaller: yes
    widescreen: yes
    theme: cosmo
    css: slideStyles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Data Discovery in R

## Goals
- Introduce newer approaches to data wranging, scrubbing, manipulation etc.

- Show the benefits of piping code

- Put it all together with some newer visualization packages



## Outline 
- Newer approaches to data wrangling
    - Introduction to plyr dplyr and tidyr
    - Subsetting rows
    - Subsetting columns
    - Reshaping data
    - Generating new data
    - Grouping and summarizing

- Nothin's gonna stop the flow
    - Piping with the magrittr package

- Quick interactive visualizations
    - Using *yr packages, piping and visualization
    - ggvis
    - htmlwidgets
    
    

# Newer approaches to data wrangling
## Newer approaches to data wrangling
- A starting example

- Let's say we want to select from our data only the following variables
    - The variables X1:X10, which are not all together, and there are many more 'X' columns
    - The variables Y1 and Y2, which are the only Y variables in the data
    - Any variable that starts with XYZ
    
- How might we go about this?

## Some base R approaches

```{r, eval=FALSE, echo=TRUE}
newData = oldData[,c(1,2,3,4, etc.)]
newData = oldData[,c('X1', 'X2', etc.)]
newData = oldData[,c(paste0('X', 1:10), 'Y1', 'Y2', grep(colnames(oldData), '^XYZ', value=T))]
newData = subset(oldData, select = c(paste0('X', 1:10), 'Y1', 'Y2', 
                                     grep(colnames(oldData), '^XYZ', value=T)))
```

## More
- What if you also want any where Z = 'Yes', Q = 'No', and only the last 50 of those results, ordered by Y1 (descending)?

```{r2, eval=FALSE, echo=TRUE}
newData = newData[oldData$Z == 'Yes' & oldData$Q == 'No',]
newData = tail(newData, 50)
newData = newdata[order(newdata$Y1, decreasing=T)]
```

## An alternative

```{r, eval=FALSE, echo=TRUE}
newData = oldData %>% 
  select(one_of(paste0('X', 1:10)), contains('Y'), starts_with('XYZ')) %>% 
  filter(Z == 'Yes', Q == 'No') %>% 
  tail(50) %>% 
  desc(Y1)
```

## An alternative

- Even though the former is probably more concise than many would do on their own, it still is: 
    - noisier
    - less legible
    - less amenable to additional changes
    - requires esoteric knowledge (e.g. regular expressions)

# Another example...

## Start with a string, end with a map

```{r, eval=FALSE, echo=TRUE}
packs = c('magrittr', 'rvest', 'dplyr', 'stringr' ,'leaflet', 'ggvis')
sapply(packs, library, character.only=T)

# a color palette to be used later
pal = colorNumeric(palette = c('Red', 'White', 'Navy'), test0$popDiff)  

wikiURL = 'https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population'

# Let's go!
wikiURL %>% 
  html %>% 
  html_node(css='.wikitable.sortable') %>% 
  html_table %>% 
  sapply(function(x) repair_encoding(as.character(x), 'UTF-8')) %>%
  data.frame %>%  
  mutate(City = str_replace(City, '\\[(.*?)\\]', ''),
         latlon = sapply(str_split(Location, '/'), last), 
         latlon = str_extract_all(latlon, '[-|[0-9]]+\\.[0-9]+'), 
         lat = sapply(latlon, first),
         lon = sapply(latlon, nth, 2), 
         population2014 = as.numeric(str_replace_all(X2014.estimate, ',', '')),
         population2010 = as.numeric(str_replace_all(X2010.Census, ',', '')),
         popDiff  = round(population2014/population2010 - 1, 2)*100) %>% 
```

## Cont'd.

```{r, eval=FALSE, echo=TRUE}
  select(-latlon, -Location) %>% 
  filter(as.numeric(as.character(X2014.rank)) <= 50)  %>% 
  leaflet %>% 
  addProviderTiles("CartoDB.DarkMatterNoLabels") %>% 
  setView(-94, 35, zoom = 4) %>% 
  addCircleMarkers(~lon, ~lat,
                   radius=  ~scales::rescale(popDiff, c(1, 10)),
                   fillColor=  ~pal(popDiff), stroke = FALSE, fillOpacity = .85,
                   popup=  ~paste(City, paste0(popDiff, '%')))
```

And voila...

##
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# packs = c('magrittr', 'rvest', 'dplyr', 'stringr' ,'leaflet', 'ggvis')
# sapply(packs, library, character.only=T)
library(magrittr); library(rvest); library(dplyr); library(dplyr); library(stringr)
library(leaflet)

'https://en.wikipedia.org/wiki/List_of_United_States_cities_by_population' %>% 
  html %>% 
  html_node(css='.wikitable.sortable') %>% 
  html_table %>% 
  sapply(function(x) repair_encoding(as.character(x), 'UTF-8')) %>%
  data.frame %>%  
  mutate(City = str_replace(City, '\\[(.*?)\\]', ''),
         latlon = sapply(str_split(Location, '/'), last), 
         latlon = str_extract_all(latlon, '[-|[0-9]]+\\.[0-9]+'), 
         lat = sapply(latlon, first),
         lon = sapply(latlon, nth, 2), 
         population2014 = as.numeric(str_replace_all(X2014.estimate, ',', '')),
         population2010 = as.numeric(str_replace_all(X2010.Census, ',', '')),
         popDiff  = round(population2014/population2010 - 1, 2)*100) %T>% 
  select(-latlon, -Location) %>% 
  filter(as.numeric(as.character(X2014.rank)) <= 50)  %>% 
  leaflet %>% 
  addProviderTiles("CartoDB.DarkMatterNoLabels") %>% 
  setView(-94, 35, zoom = 4) %>% 
  addCircleMarkers(~lon, ~lat,
                   radius=  ~scales::rescale(popDiff, c(1, 10)),
                   fillColor=  ~colorNumeric(palette = c('Red', 'White', 'Navy'), popDiff)(popDiff), 
                   stroke = FALSE, fillOpacity = .85,
                   popup=  ~paste(City, paste0(popDiff, '%')))
```


## 

- In the interests of your own code, the previous is not recommended.
- It serves as an illustration of what's possible.

## Newer approaches to data wrangling
- Over the past couple of years, a handful of packages have been put out that make data management within R noticeably easier
- We will focus on plyr, dplyr, tidyr, and maybe reshape2
- But others, e.g. data.table, take different approaches and may be useful as well
- Newer visualization packages take advantage of these approaches to data manipulation
